<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#090c12">
  <title>üìú –õ–∏—Å—Ç–∞—Ä–∏—Å</title>
  
  <!-- PWA: Manifest -->
  <link rel="manifest" href="#manifest">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script type="application/json" id="manifest">
  {
    "name": "–õ–∏—Å—Ç–∞—Ä–∏—Å",
    "short_name": "–õ–∏—Å—Ç–∞—Ä–∏—Å",
    "description": "–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞ –ø—Ä–æ –∞—Ä—Ö–µ–æ–ª–æ–≥–∞, —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–≥–æ —Ç–∞–π–Ω—ã –¥—Ä–µ–≤–Ω–µ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#090c12",
    "theme_color": "#090c12",
    "icons": [
      {
        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%230f172a'/%3E%3Ctext x='64' y='78' text-anchor='middle' font-size='60' fill='%235e60ce'%3Eüìú%3C/text%3E%3C/svg%3E",
        "sizes": "128x128",
        "type": "image/svg+xml"
      },
      {
        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle cx='256' cy='256' r='240' fill='%230f172a'/%3E%3Ctext x='256' y='300' text-anchor='middle' font-size='200' fill='%235e60ce'%3Eüìú%3C/text%3E%3C/svg%3E",
        "sizes": "512x512",
        "type": "image/svg+xml"
      }
    ]
  }
  </script>

  <!-- PWA: Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => {
          console.warn('SW registration failed:', err);
        });
      });
    }
  </script>
  <script>
    // Service Worker (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª)
    if (typeof window !== 'undefined') {
      const swCode = `
        const CACHE_NAME = 'listaris-v1';
        const urlsToCache = [
          './',
          './?standalone=true'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', event => {
          if (event.request.method !== 'GET') return;
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
          );
        });
      `;
      const blob = new Blob([swCode], {type: 'application/javascript'});
      const url = URL.createObjectURL(blob);
      // –ü–æ–¥–º–µ–Ω—è–µ–º register, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å blob
      const originalRegister = navigator.serviceWorker.register;
      navigator.serviceWorker.register = function() {
        return originalRegister.call(this, url, { scope: './' });
      };
    }

    // –°–∂–∞—Ç–∏–µ
    const compress = (str) => {
      const data = new TextEncoder().encode(str);
      const cs = new CompressionStream('deflate');
      const writer = cs.writable.getWriter();
      writer.write(data);
      writer.close();
      return new Response(cs.readable).arrayBuffer().then(ab => 
        btoa(String.fromCharCode(...new Uint8Array(ab)))
      );
    };
    const decompress = async (b64) => {
      try {
        const bin = atob(b64);
        const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
        const ds = new DecompressionStream('deflate');
        const writer = ds.writable.getWriter();
        writer.write(bytes);
        writer.close();
        const ab = await new Response(ds.readable).arrayBuffer();
        return new TextDecoder().decode(ab);
      } catch (e) {
        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    };
  </script>
  <style>
    :root {
      --bg: #090c12;
      --card: #141a26;
      --panel: #1a2335;
      --text: #e2e8f0;
      --muted: #64748b;
      --accent: #5e60ce;
      --accent-light: #4cc9f0;
      --success: #4ade80;
      --experiment: #7209b7;
      --crit: #ffcc00;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 12px;
      line-height: 1.5;
      overflow-x: hidden;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    @media (max-width: 600px) {
      .container { padding: 8px; }
      body { padding: 0; }
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 2.4rem;
      background: linear-gradient(90deg, #5e60ce, #4cc9f0);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin: 16px 0;
      letter-spacing: -0.5px;
    }
    @media (max-width: 480px) {
      h1 { font-size: 2rem; }
    }

    .resources {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 18px;
    }
    .res {
      background: var(--card);
      padding: 14px 12px;
      border-radius: 12px;
      text-align: center;
      font-size: 1rem;
      position: relative;
    }
    .res-value {
      font-weight: bold;
      font-size: 1.5rem;
      margin-bottom: 4px;
    }
    .res-label {
      font-size: 0.95rem;
      opacity: 0.8;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }
    .res-per-sec {
      font-size: 0.85rem;
      opacity: 0.6;
      margin-top: 4px;
    }
    .res-icon { font-size: 1.3rem; }

    #actionZone {
      background: var(--panel);
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    @media (max-width: 480px) {
      #actionZone { padding: 16px; }
    }
    .action-title {
      font-size: 1.3rem;
      margin-bottom: 16px;
      color: var(--accent-light);
    }
    #clickBtn {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: white;
      border: 2px solid var(--accent);
      width: 200px;
      height: 200px;
      border-radius: 50%;
      font-size: 1.6rem;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      margin: 0 auto;
    }
    @media (max-width: 480px) {
      #clickBtn {
        width: 160px;
        height: 160px;
        font-size: 1.4rem;
      }
    }
    #clickBtn:hover {
      transform: scale(1.04);
      box-shadow: 0 0 25px rgba(94, 96, 206, 0.5);
    }
    #clickBtn:active {
      transform: scale(0.96);
    }
    #clickBtn::after {
      content: 'üìú';
      position: absolute;
      font-size: 3.5rem;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0.15;
    }

    .toasts {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 320px;
      max-width: 90vw;
      pointer-events: none;
    }
    .toast {
      background: rgba(30, 41, 59, 0.95);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      border-left: 4px solid var(--accent);
      animation: slideInRight 0.3s forwards, fadeOut 0.5s 2.5s forwards;
      word-wrap: break-word;
    }
    .toast.event { border-left-color: var(--experiment); }
    .toast.achievement { border-left-color: var(--success); }
    @keyframes slideInRight {
      from { transform: translateX(150%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab {
      background: var(--card);
      border: none;
      color: var(--muted);
      padding: 10px 14px;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .tab.active {
      background: var(--panel);
      color: white;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
    }
    .tab:hover:not(.active) {
      background: #1e293b;
    }
    @media (max-width: 480px) {
      .tab { padding: 8px 10px; font-size: 0.85rem; }
    }

    .tab-content {
      background: var(--card);
      border-radius: 0 0 12px 12px;
      padding: 18px;
      min-height: 300px;
    }
    @media (max-width: 600px) {
      .tab-content { padding: 14px; }
    }

    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }
    @media (max-width: 600px) {
      .items-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
    }
    .item-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 16px;
      transition: background 0.3s;
    }
    .item-card:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    .item-title {
      font-size: 1.25rem;
      margin-bottom: 8px;
      color: var(--accent-light);
    }
    .item-desc {
      font-size: 0.95rem;
      opacity: 0.85;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .item-stats {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-bottom: 14px;
    }
    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      font-size: 1rem;
    }
    .btn:hover:not(:disabled) {
      background: #4d50b9;
      transform: translateY(-2px);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-bought {
      background: var(--success) !important;
      cursor: default;
    }
    .btn-experiment {
      background: var(--experiment);
    }
    .btn-experiment:hover:not(:disabled) {
      background: #5e0799;
    }

    .particle {
      position: absolute;
      pointer-events: none;
      font-weight: bold;
      text-shadow: 0 0 6px rgba(0,0,0,0.8);
      animation: floatUp 1s forwards;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-100px) scale(0.9); }
    }

    .save-section {
      margin-top: 16px;
    }
    .save-input {
      width: 100%;
      background: #0f172a;
      color: #e2e8f0;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      font-size: 0.85rem;
      margin: 10px 0;
    }
    .save-btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    @media (max-width: 480px) {
      .save-btns { flex-direction: column; }
      .save-btns .btn { width: 100%; }
    }

    .quote {
      font-style: italic;
      opacity: 0.9;
      border-left: 3px solid var(--accent);
      padding: 12px 16px;
      margin: 16px 0;
      background: rgba(94, 96, 206, 0.05);
      border-radius: 0 8px 8px 0;
    }

    .lore-content {
      line-height: 1.7;
      opacity: 0.9;
    }
    .lore-content h3 {
      color: var(--accent-light);
      margin: 16px 0 10px;
    }
    .lore-contact {
      text-align: center;
      padding: 16px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.95rem;
      margin-top: 20px;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      opacity: 0.6;
      font-size: 0.9rem;
    }

    /* Install prompt */
    #installPrompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: var(--panel);
      padding: 12px 16px;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    #installBtn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="toasts">
      <div v-for="t in toasts" 
           :key="t.id" 
           class="toast" 
           :class="{'event': t.type === 'event', 'achievement': t.type === 'achievement'}">
        {{ t.text }}
      </div>
    </div>

    <header>
      <h1>üìú –õ–∏—Å—Ç–∞—Ä–∏—Å</h1>
    </header>

    <div class="resources">
      <div class="res">
        <div class="res-label"><span class="res-icon">üìú</span> –õ–∏—Å—Ç—ã</div>
        <div class="res-value">{{ fmt(coins) }}</div>
        <div class="res-per-sec" v-if="getCoinsPerSec() > 0">+{{ fmt(getCoinsPerSec()) }}/—Å–µ–∫</div>
      </div>
      <div class="res" v-if="showEnergy()">
        <div class="res-label"><span class="res-icon">‚ö°</span> –≠–Ω–µ—Ä–≥–∏—è</div>
        <div class="res-value">{{ fmt(energy) }}</div>
        <div class="res-per-sec" v-if="getEnergyPerSec() > 0">+{{ fmt(getEnergyPerSec()) }}/—Å–µ–∫</div>
      </div>
      <div class="res" v-if="showCrystals()">
        <div class="res-label"><span class="res-icon">üíé</span> –ö—Ä–∏—Å—Ç–∞–ª–ª—ã</div>
        <div class="res-value">{{ fmt(crystals) }}</div>
        <div class="res-per-sec" v-if="getCrystalsPerSec() > 0">+{{ fmt(getCrystalsPerSec()) }}/—Å–µ–∫</div>
      </div>
      <div class="res" v-if="souls > 0 || prestigeLevel > 0">
        <div class="res-label"><span class="res-icon">üß†</span> –ü–æ–Ω–∏–º–∞–Ω–∏–µ</div>
        <div class="res-value">{{ souls }}</div>
      </div>
    </div>

    <div id="actionZone">
      <div class="action-title">–õ–ò–°–¢–ê–ô –ö–Ω–∏–≥—É –í—Å–µ–ª–µ–Ω–Ω–æ–π</div>
      <button id="clickBtn" @click="click">üìú</button>
      <div v-for="p in particles" 
           :key="p.id"
           class="particle"
           :style="{
             left: p.x + 'px',
             top: p.y + 'px',
             color: p.color,
             fontSize: p.size
           }">
        {{ p.text }}
      </div>
    </div>

    <div class="tabs">
      <button class="tab" :class="{active: activeTab === 'dig'}" @click="activeTab = 'dig'">‚õèÔ∏è –†–∞—Å–∫–æ–ø–∫–∏</button>
      <button class="tab" :class="{active: activeTab === 'research'}" @click="activeTab = 'research'">üî¨ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</button>
      <button class="tab" :class="{active: activeTab === 'experiments'}" @click="activeTab = 'experiments'">üß™ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã</button>
      <button class="tab" :class="{active: activeTab === 'achievements'}" @click="activeTab = 'achievements'">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
      <button class="tab" :class="{active: activeTab === 'lore'}" @click="activeTab = 'lore'">üìñ –õ–æ—Ä</button>
      <button class="tab" :class="{active: activeTab === 'save'}" @click="activeTab = 'save'">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</button>
    </div>

    <div class="tab-content">
      <!-- –†–∞—Å–∫–æ–ø–∫–∏ -->
      <div v-if="activeTab === 'dig'">
        <h2 style="color: var(--accent-light); margin-bottom: 16px;">üèóÔ∏è –ê—Ä—Ö–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–ª–µ–∫—Å—ã</h2>
        <p style="opacity: 0.8; margin-bottom: 16px;">–°—Ç—Ä–æ–π—Ç–µ —Å–æ–æ—Ä—É–∂–µ–Ω–∏—è ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å –õ–∏—Å—Ç—ã –∏ —Ä–µ—Å—É—Ä—Å—ã.</p>
        <div class="items-grid">
          <div class="item-card" v-for="b in getVisibleBuildings()" :key="b.id">
            <div class="item-title">{{ b.name }} ({{ b.count }})</div>
            <div class="item-desc">{{ b.desc }}</div>
            <div class="item-stats">
              +{{ fmt(getBuildingIncome(b)) }} üìú/—Å–µ–∫<br>
              –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ fmt(getBuildingCost(b)) }} üìú
            </div>
            <button class="btn" 
                    @click="buyBuilding(b)"
                    :disabled="coins < getBuildingCost(b)">
              –†–∞—Å–∫–æ–ø–∞—Ç—å
            </button>
          </div>
        </div>
      </div>

      <!-- –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è -->
      <div v-if="activeTab === 'research'">
        <h2 style="color: var(--accent-light); margin-bottom: 16px;">üî¨ –ù–∞—É—á–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è</h2>
        <p style="opacity: 0.8; margin-bottom: 16px;">–ò–∑—É—á–∞–π—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –¥—Ä–µ–≤–Ω–∏—Ö, —á—Ç–æ–±—ã —É—Å–∏–ª–∏—Ç—å —Å–≤–æ—é —Ä–∞–±–æ—Ç—É.</p>
        <div class="items-grid">
          <div class="item-card" v-for="u in getVisibleUpgrades()" :key="u.id">
            <div class="item-title">{{ u.name }} {{ u.bought ? '‚úÖ' : '' }}</div>
            <div class="item-desc">{{ u.desc }}</div>
            <div class="item-stats">–¶–µ–Ω–∞: {{ fmt(u.cost) }} {{ u.costRes }}</div>
            <button 
              class="btn" 
              :class="{'btn-bought': u.bought}"
              @click="buyUpgrade(u)"
              :disabled="u.bought || !canAfford(u)">
              {{ u.bought ? '–ò–∑—É—á–µ–Ω–æ' : '–ò–∑—É—á–∏—Ç—å' }}
            </button>
          </div>
        </div>
      </div>

      <!-- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã -->
      <div v-if="activeTab === 'experiments'">
        <h2 style="color: var(--accent-light); margin-bottom: 16px;">üß™ –ü–æ–ª–µ–≤—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã</h2>
        <p style="opacity: 0.8; margin-bottom: 16px;">–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—ã ‚Äî –∑–∞ –ø–ª–∞—Ç—É –∏ —Å —Ä–∏—Å–∫–æ–º.</p>
        <div class="items-grid">
          <div class="item-card" v-for="e in getVisibleExperiments()" :key="e.id">
            <div class="item-title">{{ e.name }}</div>
            <div class="item-desc">{{ e.desc }}</div>
            <div class="item-stats" v-if="e.cost > 0">–¶–µ–Ω–∞: {{ fmt(e.cost) }} üìú</div>
            <div class="item-stats" v-if="e.energyCost > 0">–¢—Ä–µ–±—É–µ—Ç: {{ e.energyCost }} ‚ö°</div>
            <div class="item-stats" v-if="e.cooldown > 0">–û–∂–∏–¥–∞–Ω–∏–µ: {{ e.cooldown }} —Å–µ–∫</div>
            <button 
              class="btn btn-experiment"
              @click="runExperiment(e)"
              :disabled="!canRunExperiment(e)">
              {{ e.cooldown > 0 ? '‚è≥' : e.buttonText }}
            </button>
          </div>
        </div>
      </div>

      <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
      <div v-if="activeTab === 'achievements'">
        <h2 style="color: var(--accent-light); margin-bottom: 16px;">üèÜ –ê—Ä—Ö–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã</h2>
        <div class="items-grid">
          <div class="item-card" v-for="a in achievements" :key="a.id">
            <div class="item-title" :style="{opacity: a.unlocked ? 1 : 0.6}">
              {{ a.name }} {{ a.unlocked ? 'üèÜ' : 'üîí' }}
            </div>
            <div class="item-desc">{{ a.desc }}</div>
            <div v-if="!a.unlocked" class="item-stats">–ü—Ä–æ–≥—Ä–µ—Å—Å: {{ getAchievementProgress(a) }}%</div>
          </div>
        </div>
        <div v-if="quotes.length" class="quote">
          ¬´{{ currentQuote }}¬ª
        </div>
      </div>

      <!-- –õ–æ—Ä -->
      <div v-if="activeTab === 'lore'" class="lore-content">
        <h3>I. –ù–∞—á–∞–ª–æ</h3>
        <p>–ü–ª–∞–Ω–µ—Ç–∞ –õ–∏—Å—Ç–∞—Ä–∏—Å ‚Äî –Ω–µ –∫–∞–º–µ–Ω–Ω–∞—è –≥–ª—ã–±–∞. –≠—Ç–æ <i>–æ–≥—Ä–æ–º–Ω–∞—è –∫–Ω–∏–≥–∞</i>, —É–ø–∞–∫–æ–≤–∞–Ω–Ω–∞—è –≤ –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –ø–ª–∞—Å—Ç –æ—Å–∞–¥–æ—á–Ω—ã—Ö –ø–æ—Ä–æ–¥. –ö–∞–∂–¥–∞—è –≥–ª–∞–≤–∞ ‚Äî —ç–ø–æ—Ö–∞.</p>
        
        <h3>II. –ö–æ—Å–º–æ-–õ–∏—Å—Ç–∞—Ä—ã</h3>
        <p>–ò—Ö —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Å—Ç—Ä–æ–∏–ª–∞ –±–∞—à–Ω–∏ –≤ –Ω–µ–±–æ ‚Äî –æ–Ω–∏ <i>–∫–æ–ø–∞–ª–∏ –≤–≥–ª—É–±—å</i>, –∫ —è–¥—Ä—É, –≥–¥–µ, –ø–æ –∏—Ö –≤–µ—Ä–æ–≤–∞–Ω–∏—è–º, —Ö—Ä–∞–Ω–∏–ª—Å—è ¬´–ü–µ—Ä–≤—ã–π –õ–∏—Å—Ç¬ª ‚Äî –∫–æ–¥ –í—Å–µ–ª–µ–Ω–Ω–æ–π. –û–Ω–∏ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª–∏ ‚Äî –æ–Ω–∏ <i>–ª–∏—Å—Ç–∏–ª–∏</i> —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å, –º–µ–Ω—è—è –µ—ë —á–µ—Ä–µ–∑ —Ä–∏—Ç—É–∞–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ.</p>
        
        <h3>III. –ö—Ä–∞—Ö</h3>
        <p>–ö–æ–≥–¥–∞ –æ–Ω–∏ –¥–æ–±—Ä–∞–ª–∏—Å—å –¥–æ —è–¥—Ä–∞, –æ–Ω–∏ <i>–ø—Ä–æ—á–∏—Ç–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ</i>. –†–µ–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ –≤—ã–¥–µ—Ä–∂–∞–ª–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ ‚Äî –∏ —Å—Ö–ª–æ–ø–Ω—É–ª–∞—Å—å. –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –æ–±–µ–ª–∏—Å–∫–∏, —à–µ–ø—á—É—â–∏–µ —Ü–∏—Ç–∞—Ç—ã –≤ —ç—Ñ–∏—Ä.</p>
        
        <h3>IV. –¢—ã</h3>
        <p>–¢—ã ‚Äî –Ω–µ –∑–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å. –¢—ã ‚Äî <i>—á–∏—Ç–∞—Ç–µ–ª—å</i>. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å, –∞ <i>–ø–æ–Ω—è—Ç—å</i>. –ö–∞–∂–¥—ã–π –∫–ª–∏–∫ ‚Äî —ç—Ç–æ –ø–æ–≤–æ—Ä–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ö–∞–∂–¥–æ–µ –∑–¥–∞–Ω–∏–µ ‚Äî –Ω–æ–≤–∞—è –≥–ª–∞–≤–∞. –ö–∞–∂–¥–æ–µ –ü–æ–Ω–∏–º–∞–Ω–∏–µ ‚Äî —à–∞–≥ –∫ –ü–µ—Ä–≤–æ–π –°—Ç—Ä–∞–Ω–∏—Ü–µ.</p>
        
        <h3>V. –ê–≤—Ç–æ—Ä—Å—Ç–≤–æ (–ì–ª–∞–≤–∞ IV)</h3>
        <p>–ö–æ–≥–¥–∞ —Ç—ã –æ—Å–æ–∑–Ω–∞–µ—à—å —Å–µ–±—è –∫–∞–∫ —Å–æ-–∞–≤—Ç–æ—Ä–∞ –í—Å–µ–ª–µ–Ω–Ω–æ–π, —Ç—ã –ø–µ—Ä–µ—Å—Ç–∞–µ—à—å –ª–∏—Å—Ç–∞—Ç—å ‚Äî —Ç—ã <i>–ø–∏—à–µ—à—å</i>. –¢–≤–æ–∏ –∫–ª–∏–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±—É–∫–≤–∞–º–∏, –∑–¥–∞–Ω–∏—è ‚Äî –∞–±–∑–∞—Ü–∞–º–∏, –∞ –ü–æ–Ω–∏–º–∞–Ω–∏–µ ‚Äî –ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π. –¢—ã –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—à—å –∫–Ω–∏–≥—É. –¢—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å –µ—ë.</p>

        <div class="lore-contact">
          üì¨ –í–æ–ø—Ä–æ—Å—ã, –∏–¥–µ–∏, –ø—Ä–æ–∑—Ä–µ–Ω–∏—è? –ü–∏—à–∏—Ç–µ: <b>johnbrotherwood@gmail.com</b>
        </div>

        <div class="quote" v-if="currentLoreQuote">
          ¬´{{ currentLoreQuote }}¬ª
        </div>
      </div>

      <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ -->
      <div v-if="activeTab === 'save'">
        <h2 style="color: var(--accent-light); margin-bottom: 16px;">üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–æ–º</h2>
        <p style="opacity: 0.8; margin-bottom: 16px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∂–µ.</p>
        
        <div class="save-section">
          <button class="btn" @click="exportSave">üì§ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
          <input ref="saveInput" v-model="saveCode" class="save-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è..." />
          <div class="save-btns">
            <button class="btn" style="background: var(--success);" @click="importSave">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="btn" style="background: #64748b;" @click="saveCode = ''">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <p v-if="saveMessage" :style="{color: saveMessage.includes('–£—Å–ø–µ—Ö') ? 'var(--success)' : '#f87171', marginTop: '8px'}">
            {{ saveMessage }}
          </p>
        </div>
      </div>
    </div>

    <footer>
      üåå –ê–Ω–¥—Ä–µ–π, —Ç—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏–≥—Ä–∞–µ—à—å. –¢—ã ‚Äî —á–∏—Ç–∞–µ—à—å –í—Å–µ–ª–µ–Ω–Ω—É—é.
    </footer>
  </div>

  <!-- PWA: Install prompt -->
  <div id="installPrompt">
    <div>–•–æ—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ¬´–õ–∏—Å—Ç–∞—Ä–∏—Å¬ª –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?</div>
    <button id="installBtn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  </div>

  <script>
    const { createApp } = Vue;

    const QUOTES = [
      "–ö–∞–∂–¥—ã–π –∫–ª–∏–∫ ‚Äî —ç—Ç–æ –≤–æ–ø—Ä–æ—Å. –ö–∞–∂–¥—ã–π –õ–∏—Å—Ç ‚Äî –æ—Ç–≤–µ—Ç.",
      "–≠–Ω–µ—Ä–≥–∏—è ‚Äî –Ω–µ —Ç–æ–ø–ª–∏–≤–æ. –≠—Ç–æ –≤–Ω–∏–º–∞–Ω–∏–µ –í—Å–µ–ª–µ–Ω–Ω–æ–π –∫ —Ç–≤–æ–µ–º—É —á—Ç–µ–Ω–∏—é.",
      "–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–æ–∂–¥–∞–µ—Ç—Å—è –Ω–µ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏, –∞ –æ—Ç –≥–ª—É–±–∏–Ω—ã.",
      "–û–±–µ–ª–∏—Å–∫ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç. –û–Ω –∂–¥—ë—Ç, –ø–æ–∫–∞ —Ç—ã –Ω–∞—É—á–∏—à—å—Å—è —Å–ª—É—à–∞—Ç—å —Ç–∏—à–∏–Ω—É –º–µ–∂–¥—É –±—É–∫–≤–∞–º–∏.",
      "–ö—Ä–∏—Å—Ç–∞–ª–ª—ã ‚Äî —ç—Ç–æ –∑–∞—Å—Ç—ã–≤—à–∏–µ –º—ã—Å–ª–∏ –¥—Ä–µ–≤–Ω–∏—Ö. –ò—Ö –Ω—É–∂–Ω–æ –Ω–µ –¥–æ–±—ã–≤–∞—Ç—å ‚Äî —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å.",
      "–ì–ª–∞–≤–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–µ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –∫–æ–Ω—á–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç, –∞ –∫–æ–≥–¥–∞ —á–∏—Ç–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—É –∏ –∑–∞–¥—É–º—ã–≤–∞–µ—Ç—Å—è.",
      "–¢—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—à—å —Å–º—ã—Å–ª. –¢—ã ‚Äî –¥–∞—ë—à—å –µ–≥–æ.",
      "–ö–æ–≥–¥–∞ —Ç—ã –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—à—å –ª–∏—Å—Ç–∞—Ç—å –∏ –Ω–∞—á–Ω—ë—à—å –ø–∏—Å–∞—Ç—å ‚Äî –Ω–∞—á–Ω—ë—Ç—Å—è –ì–ª–∞–≤–∞ IV."
    ];

    const LORE_QUOTES = [
      "–¢–æ—Ç, –∫—Ç–æ –ª–∏—Å—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ, –≤–∏–¥–∏—Ç —Å—é–∂–µ—Ç. –¢–æ—Ç, –∫—Ç–æ –ª–∏—Å—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ ‚Äî –ø–æ–Ω–∏–º–∞–µ—Ç —Å–º—ã—Å–ª.",
      "–ö–æ—Å–º–æ-–õ–∏—Å—Ç–∞—Ä—ã –Ω–µ –≤–µ—Ä–∏–ª–∏ –≤ —Å–º–µ—Ä—Ç—å. –û–Ω–∏ –≤–µ—Ä–∏–ª–∏ –≤ –ø–∞—É–∑—É –º–µ–∂–¥—É –≥–ª–∞–≤–∞–º–∏.",
      "–ü–µ—Ä–≤—ã–π –õ–∏—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –í—Å–µ–ª–µ–Ω–Ω–∞—è –∏—â–µ—Ç –æ—Ç–≤–µ—Ç –≤–æ—Ç —É–∂–µ 13.8 –º–∏–ª–ª–∏–∞—Ä–¥–æ–≤ –ª–µ—Ç.",
      "–ê–≤—Ç–æ—Ä—Å—Ç–≤–æ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–∞–≤–æ. –≠—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∫–∞–∂–¥—É—é –∑–∞–ø—è—Ç—É—é –≤ –∫–æ–¥–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏."
    ];

    createApp({
      data() {
        return {
          coins: 0,
          energy: 0,
          crystals: 0,
          souls: 0,
          totalClicks: 0,
          totalCoins: 0,
          clickPower: 1,
          critChance: 0.05,
          critMultiplier: 3,
          chapter: 1,
          prestigeLevel: 0,
          buildings: [
            { id: 'excavator', name: '–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–Ω—ã–π —Ä–æ–π', desc: '–†–æ–±–æ—Ç—ã-–º—É—Ä–∞–≤—å–∏ –∫–æ–ø–∞—é—Ç –ø–µ—Ä–≤—ã–π —Å–ª–æ–π', baseIncome: 0.2, count: 0, costBase: 25, costExp: 1.12, chapter: 1 },
            { id: 'lab', name: '–ü–æ–ª–µ–≤–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', desc: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –õ–∏—Å—Ç—ã, –≤—ã–¥–µ–ª—è—è –≠–Ω–µ—Ä–≥–∏—é', baseIncome: 0.05, count: 0, costBase: 150, costExp: 1.1, chapter: 1 },
            { id: 'crystalMine', name: '–ö—Ä–∏—Å—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è —à–∞—Ö—Ç–∞', desc: '–î–æ–±—ã–≤–∞–µ—Ç –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–ª–æ—è', baseIncome: 0.01, count: 0, costBase: 500, costExp: 1.08, chapter: 2 },
            { id: 'obelisk', name: '–û–±–µ–ª–∏—Å–∫ –ü–∞–º—è—Ç–∏', desc: '–°–≤—è–∑—å —Å –¥—Ä–µ–≤–Ω–∏–º–∏ —Ä–∞–∑—É–º–∞–º–∏', baseIncome: 0.001, count: 0, costBase: 5000, costExp: 1.05, chapter: 2 },
            { id: 'authorTable', name: '–ü–∏—Å–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ç–æ–ª', desc: '–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–µ –õ–∏—Å—Ç—ã', baseIncome: 0.0005, count: 0, costBase: 50000, costExp: 1.04, chapter: 4 }
          ],
          upgrades: [
            { id: 'strongerHands', name: '–°–∏–ª—å–Ω—ã–µ —Ä—É–∫–∏', desc: '+1 –∫ –ª–∏—Å—Ç–∞–Ω–∏—é', cost: 50, costRes: 'üìú', bought: false, effect: () => { this.clickPower += 1; }, chapter: 1 },
            { id: 'crit', name: '–û—Å—Ç—Ä—ã–π –≤–∑–≥–ª—è–¥', desc: '5% —à–∞–Ω—Å √ó3 (–ª–∏—Å—Ç —Å —Ç—Ä–µ—Å–∫–æ–º!)', cost: 200, costRes: 'üìú', bought: false, effect: () => { this.critChance += 0.05; }, chapter: 1 },
            { id: 'robotHelpers', name: '–†–æ–±–æ-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã', desc: '–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä—ã √ó2', cost: 400, costRes: 'üìú', bought: false, effect: () => {}, chapter: 1 },
            { id: 'energyConverter', name: '–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —ç–Ω–µ—Ä–≥–∏–∏', desc: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –¥–∞—é—Ç +50% –≠–Ω–µ—Ä–≥–∏–∏', cost: 800, costRes: 'üìú', bought: false, effect: () => { this.energyBonus = 0.5; }, chapter: 2 },
            { id: 'crystalFocus', name: '–§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤', desc: '–ö—Ä–∏—Å—Ç–∞–ª–ª—ã –ø—Ä–∏–Ω–æ—Å—è—Ç +10% –≠–Ω–µ—Ä–≥–∏–∏', cost: 30, costRes: 'üíé', bought: false, effect: () => { this.crystalEnergyBonus = 0.1; }, chapter: 2 },
            { id: 'prestige', name: '–ü–µ—Ä–≤–æ–µ –ø—Ä–æ–∑—Ä–µ–Ω–∏–µ', desc: '–°–±—Ä–æ—Å—å –≤—Å—ë –∏ –ø–æ–ª—É—á–∏ –ü–æ–Ω–∏–º–∞–Ω–∏–µ', cost: 10000, costRes: 'üìú', bought: false, effect: this.prestige, chapter: 2 },
            { id: 'authorPen', name: '–ü–µ—Ä–æ –ê–≤—Ç–æ—Ä–∞', desc: '–ö–ª–∏–∫–∏ –¥–∞—é—Ç +0.1 –ü–æ–Ω–∏–º–∞–Ω–∏—è', cost: 20, costRes: 'üß†', bought: false, effect: () => { this.authorPower = 0.1; }, chapter: 4 },
            { id: 'realityInk', name: '–ß–µ—Ä–Ω–∏–ª–∞ –†–µ–∞–ª—å–Ω–æ—Å—Ç–∏', desc: '–ü–æ–Ω–∏–º–∞–Ω–∏–µ –¥–∞—ë—Ç +1% –∫–æ –≤—Å–µ–º –¥–æ—Ö–æ–¥–∞–º', cost: 5, costRes: 'üß†', bought: false, effect: () => { this.realityBonus += 0.01; }, chapter: 4 }
          ],
          energyBonus: 0,
          crystalEnergyBonus: 0,
          authorPower: 0,
          realityBonus: 0,
          experiments: [
            { 
              id: 'speedRead', 
              name: '–°–∫–æ—Ä–æ—á—Ç–µ–Ω–∏–µ', 
              desc: '√ó3 –∫ –∫–ª–∏–∫—É –Ω–∞ 8 —Å–µ–∫—É–Ω–¥', 
              cost: 500,
              energyCost: 10,
              cooldown: 0, 
              maxCooldown: 45,
              buttonText: '–õ–ò–°–¢–ê–¢–¨ –ë–´–°–¢–†–ï–ï!',
              chapter: 2,
              run: () => {
                const orig = this.clickPower;
                this.clickPower *= 3;
                setTimeout(() => { this.clickPower = orig; }, 8000);
              }
            },
            {
              id: 'soulEcho',
              name: '–≠—Ö–æ –¥—É—à',
              desc: '–ü–æ–∑–≤–∞—Ç—å –¥—Ä–µ–≤–Ω–µ–≥–æ —Ö—Ä–∞–Ω–∏—Ç–µ–ª—è ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ü–æ–Ω–∏–º–∞–Ω–∏–µ',
              cost: 5000,
              energyCost: 50,
              cooldown: 0,
              maxCooldown: 120,
              buttonText: '–ü–æ–∑–≤–∞—Ç—å —Ö—Ä–∞–Ω–∏—Ç–µ–ª—è',
              chapter: 3,
              run: () => {
                const gain = Math.max(1, Math.floor(this.coins / 10000));
                this.souls += gain;
              }
            },
            {
              id: 'writeNewPage',
              name: '–ù–∞–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É',
              desc: '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –õ–∏—Å—Ç –í—Å–µ–ª–µ–Ω–Ω–æ–π',
              cost: 1000,
              soulsCost: 1,
              cooldown: 0,
              maxCooldown: 10,
              buttonText: 'üñãÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å',
              chapter: 4,
              run: () => {
                this.coins += 1000;
                this.addToast('üñãÔ∏è –ù–æ–≤—ã–π –õ–∏—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ö–Ω–∏–≥—É!', 'event');
              }
            }
          ],
          achievements: [
            { id: 'click100', name: '100 —Å—Ç—Ä–∞–Ω–∏—Ü', desc: '–õ–∏—Å—Ç–∞–π—Ç–µ 100 —Ä–∞–∑', unlocked: false, goal: 100, current: () => this.totalClicks },
            { id: 'coins1k', name: '–¢—ã—Å—è—á–∞ –õ–∏—Å—Ç–æ–≤', desc: '–°–æ–±–µ—Ä–∏—Ç–µ 1000 –õ–∏—Å—Ç–æ–≤', unlocked: false, goal: 1000, current: () => this.coins },
            { id: 'building10', name: '–ê—Ä—Ö–µ–æ–ª–æ–≥-—Å—Ç—Ä–æ–∏—Ç–µ–ª—å', desc: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ 10 —Å–æ–æ—Ä—É–∂–µ–Ω–∏–π', unlocked: false, goal: 10, current: () => this.buildings.reduce((s,b)=>s+b.count,0) },
            { id: 'firstCrit', name: '–¢—Ä–µ—Å–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', desc: '–í–ø–µ—Ä–≤—ã–µ –ª–∏—Å—Ç–∞–π—Ç–µ —Å —Ç—Ä–µ—Å–∫–æ–º', unlocked: false, goal: 1, current: () => this.achievements.find(a=>a.id==='firstCrit')?.unlocked ? 1 : 0 },
            { id: 'author', name: '–ê–≤—Ç–æ—Ä', desc: '–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É', unlocked: false, goal: 1, current: () => this.achievements.find(a=>a.id==='author')?.unlocked ? 1 : 0 }
          ],
          activeTab: 'dig',
          particles: [],
          toasts: [],
          saveCode: '',
          saveMessage: '',
          quotes: QUOTES,
          currentQuote: QUOTES[0],
          currentLoreQuote: LORE_QUOTES[0],
          deferredPrompt: null
        }
      },

      methods: {
        fmt(num) {
          if (num >= 1e12) return (num/1e12).toFixed(2) + 'T';
          if (num >= 1e9) return (num/1e9).toFixed(2) + 'B';
          if (num >= 1e6) return (num/1e6).toFixed(2) + 'M';
          if (num >= 1e3) return (num/1e3).toFixed(1) + 'k';
          return Math.floor(num);
        },

        getRandomQuote() {
          return this.quotes[Math.floor(Math.random() * this.quotes.length)];
        },

        addToast(text, type = 'info') {
          const id = Date.now();
          this.toasts.push({ id, text, type });
          setTimeout(() => {
            this.toasts = this.toasts.filter(t => t.id !== id);
          }, 3000);
        },

        click(e) {
          this.totalClicks++;
          let amount = this.clickPower;
          let isCrit = false;

          if (Math.random() < this.critChance) {
            amount *= this.critMultiplier;
            isCrit = true;
            const ach = this.achievements.find(a => a.id === 'firstCrit');
            if (ach && !ach.unlocked) {
              ach.unlocked = true;
              this.addToast(`üèÜ ${ach.name}`, 'achievement');
            }
          }

          this.coins += amount;
          this.totalCoins += amount;
          this.souls += this.authorPower;

          const rect = e.target.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          this.spawnParticle(x, y, isCrit ? '–¢–†–ï–°–ö!' : '+' + Math.floor(amount), isCrit ? 'var(--crit)' : 'white', isCrit ? '1.5rem' : '1.2rem');

          if (this.totalClicks % 50 === 0) {
            this.currentQuote = this.getRandomQuote();
            this.addToast(`¬´${this.currentQuote}¬ª`, 'info');
          }
        },

        spawnParticle(x, y, text, color, fontSize = '1rem') {
          const id = Date.now() + Math.random();
          this.particles.push({ id, x, y, text, color, size: fontSize });
          setTimeout(() => {
            this.particles = this.particles.filter(p => p.id !== id);
          }, 1000);
        },

        // –ì–ª–∞–≤–∞ IV: –ê–≤—Ç–æ—Ä—Å—Ç–≤–æ
        unlockChapter4() {
          if (this.chapter < 4 && this.prestigeLevel >= 3) {
            this.chapter = 4;
            this.addToast(`Ï±ïÔ∏è –ì–ª–∞–≤–∞ IV –æ—Ç–∫—Ä—ã—Ç–∞: ¬´–ê–≤—Ç–æ—Ä—Å—Ç–≤–æ¬ª`, 'event');
            this.currentLoreQuote = LORE_QUOTES[3];
            const ach = this.achievements.find(a => a.id === 'author');
            if (ach && !ach.unlocked) ach.unlocked = true;
          }
        },

        // –ú–µ—Ç–æ–¥—ã –≤–º–µ—Å—Ç–æ computed (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–∫–∏)
        showEnergy() {
          return this.buildings.some(b => b.id === 'lab' && b.count > 0) || this.energy > 0;
        },
        showCrystals() {
          return this.buildings.some(b => b.id === 'crystalMine' && b.count > 0) || this.crystals > 0;
        },
        getCoinsPerSec() {
          return this.buildings.reduce((sum, b) => sum + this.getBuildingIncome(b), 0) * (1 + this.realityBonus);
        },
        getEnergyPerSec() {
          if (!this.showEnergy()) return 0;
          return (this.buildings.find(b => b.id === 'lab')?.count * 0.03 * (1 + this.energyBonus) || 0) +
                 (this.buildings.find(b => b.id === 'crystalMine')?.count * 0.005 * (1 + this.crystalEnergyBonus) || 0);
        },
        getCrystalsPerSec() {
          if (!this.showCrystals()) return 0;
          return this.buildings.find(b => b.id === 'crystalMine')?.count * 0.002 || 0;
        },

        getVisibleBuildings() {
          return this.buildings.filter(b => b.chapter <= this.chapter);
        },
        getVisibleUpgrades() {
          return this.upgrades.filter(u => u.chapter <= this.chapter);
        },
        getVisibleExperiments() {
          return this.experiments.filter(e => e.chapter <= this.chapter);
        },

        getBuildingCost(building) {
          return Math.floor(building.costBase * Math.pow(building.costExp, building.count));
        },
        getBuildingIncome(building) {
          let mult = 1;
          if (building.id === 'excavator' && this.upgrades.find(u => u.id === 'robotHelpers')?.bought) {
            mult *= 2;
          }
          return building.count * building.baseIncome * mult * (1 + this.realityBonus);
        },

        buyBuilding(building) {
          const cost = this.getBuildingCost(building);
          if (this.coins >= cost) {
            this.coins -= cost;
            building.count++;
            this.addToast(`üèóÔ∏è ${building.name} –ø–æ—Å—Ç—Ä–æ–µ–Ω`, 'info');
          }
        },

        canAfford(upgrade) {
          if (upgrade.costRes === 'üìú') return this.coins >= upgrade.cost;
          if (upgrade.costRes === 'üíé') return this.crystals >= upgrade.cost;
          if (upgrade.costRes === 'üß†') return this.souls >= upgrade.cost;
          return false;
        },
        buyUpgrade(upgrade) {
          if (upgrade.bought || !this.canAfford(upgrade)) return;
          
          if (upgrade.costRes === 'üìú') this.coins -= upgrade.cost;
          if (upgrade.costRes === 'üíé') this.crystals -= upgrade.cost;
          if (upgrade.costRes === 'üß†') this.souls -= upgrade.cost;

          upgrade.bought = true;
          upgrade.effect();
          this.addToast(`üî¨ ${upgrade.name} –∏–∑—É—á–µ–Ω–æ`, 'info');

          if (upgrade.id === 'prestige' && this.prestigeLevel < 1) {
            this.chapter = 2;
            this.addToast(`Ï±ïÔ∏è –ì–ª–∞–≤–∞ II –æ—Ç–∫—Ä—ã—Ç–∞: ¬´–û—Å–æ–∑–Ω–∞–Ω–∏–µ¬ª`, 'event');
            this.currentLoreQuote = LORE_QUOTES[1];
          } else if (this.prestigeLevel >= 1 && this.chapter < 3) {
            this.chapter = 3;
            this.addToast(`Ï±ïÔ∏è –ì–ª–∞–≤–∞ III –æ—Ç–∫—Ä—ã—Ç–∞: ¬´–ü—Ä–æ–∑—Ä–µ–Ω–∏–µ¬ª`, 'event');
            this.currentLoreQuote = LORE_QUOTES[2];
          }
          this.unlockChapter4();
        },

        canRunExperiment(exp) {
          if (exp.cooldown > 0) return false;
          if (this.coins < exp.cost) return false;
          if (exp.energyCost && this.energy < exp.energyCost) return false;
          if (exp.soulsCost && this.souls < exp.soulsCost) return false;
          return true;
        },
        runExperiment(exp) {
          if (!this.canRunExperiment(exp)) return;
          
          this.coins -= exp.cost;
          if (exp.energyCost) this.energy -= exp.energyCost;
          if (exp.soulsCost) this.souls -= exp.soulsCost;

          exp.run();
          this.addToast(`üß™ ${exp.name} –∑–∞–ø—É—â–µ–Ω`, 'event');

          exp.cooldown = exp.maxCooldown;
          const interval = setInterval(() => {
            exp.cooldown--;
            if (exp.cooldown <= 0) {
              clearInterval(interval);
            }
          }, 1000);
        },

        prestige() {
          const gain = Math.max(1, Math.floor(Math.sqrt(this.coins / 1000)));
          if (gain < 1) return;

          this.coins = 0;
          this.energy = 0;
          this.crystals = 0;
          this.buildings.forEach(b => b.count = 0);
          this.upgrades.filter(u => u.id !== 'prestige').forEach(u => u.bought = false);
          this.clickPower = 1;
          this.critChance = 0.05;
          this.energyBonus = 0;
          this.crystalEnergyBonus = 0;
          this.prestigeLevel++;

          this.souls += gain;

          if (this.prestigeLevel === 1 && this.chapter < 2) {
            this.chapter = 2;
            this.addToast(`Ï±ïÔ∏è –ì–ª–∞–≤–∞ II –æ—Ç–∫—Ä—ã—Ç–∞: ¬´–û—Å–æ–∑–Ω–∞–Ω–∏–µ¬ª`, 'event');
            this.currentLoreQuote = LORE_QUOTES[1];
          } else if (this.prestigeLevel === 2 && this.chapter < 3) {
            this.chapter = 3;
            this.addToast(`Ï±ïÔ∏è –ì–ª–∞–≤–∞ III –æ—Ç–∫—Ä—ã—Ç–∞: ¬´–ü—Ä–æ–∑—Ä–µ–Ω–∏–µ¬ª`, 'event');
            this.currentLoreQuote = LORE_QUOTES[2];
          }
          this.unlockChapter4();

          this.addToast(`üß† +${gain} –ü–æ–Ω–∏–º–∞–Ω–∏—è`, 'event');
        },

        async exportSave() {
          try {
            const state = {
              coins: this.coins,
              energy: this.energy,
              crystals: this.crystals,
              souls: this.souls,
              totalClicks: this.totalClicks,
              totalCoins: this.totalCoins,
              clickPower: this.clickPower,
              critChance: this.critChance,
              chapter: this.chapter,
              prestigeLevel: this.prestigeLevel,
              buildings: this.buildings.map(b => ({ id: b.id, count: b.count })),
              upgrades: this.upgrades.map(u => ({ id: u.id, bought: u.bought })),
              energyBonus: this.energyBonus,
              crystalEnergyBonus: this.crystalEnergyBonus,
              authorPower: this.authorPower,
              realityBonus: this.realityBonus,
              ver: '4.0'
            };
            const json = JSON.stringify(state);
            const compressed = await compress(json);
            this.saveCode = compressed;

            // –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            try {
              await navigator.clipboard.writeText(compressed);
              this.saveMessage = '‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!';
            } catch (err) {
              // –†–µ–∑–µ—Ä–≤: –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç
              this.$nextTick(() => {
                this.$refs.saveInput.focus();
                this.$refs.saveInput.select();
                this.saveMessage = 'üìã –ö–æ–¥ –≤—ã–¥–µ–ª–µ–Ω. –ù–∞–∂–º–∏—Ç–µ Ctrl+C (Cmd+C)';
              });
            }
            setTimeout(() => this.saveMessage = '', 3000);
          } catch (e) {
            this.saveMessage = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
          }
        },
        async importSave() {
          try {
            if (!this.saveCode.trim()) {
              this.saveMessage = '‚ö†Ô∏è –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
              return;
            }
            const json = await decompress(this.saveCode);
            const data = JSON.parse(json);

            Object.assign(this, {
              coins: data.coins || 0,
              energy: data.energy || 0,
              crystals: data.crystals || 0,
              souls: data.souls || 0,
              totalClicks: data.totalClicks || 0,
              totalCoins: data.totalCoins || 0,
              clickPower: data.clickPower || 1,
              critChance: data.critChance || 0.05,
              chapter: data.chapter || 1,
              prestigeLevel: data.prestigeLevel || 0,
              energyBonus: data.energyBonus || 0,
              crystalEnergyBonus: data.crystalEnergyBonus || 0,
              authorPower: data.authorPower || 0,
              realityBonus: data.realityBonus || 0
            });

            if (data.buildings) {
              this.buildings.forEach(b => {
                const saved = data.buildings.find(sb => sb.id === b.id);
                if (saved) b.count = saved.count || 0;
              });
            }
            if (data.upgrades) {
              data.upgrades.forEach(saved => {
                const u = this.upgrades.find(u => u.id === saved.id);
                if (u) u.bought = saved.bought;
              });
            }

            this.saveMessage = '‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω!';
            this.addToast('üåç –ê—Ä—Ö–∏–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
          } catch (e) {
            this.saveMessage = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: ' + e.message;
          }
        },

        getAchievementProgress(ach) {
          if (ach.unlocked) return 100;
          const current = ach.current();
          return Math.min(100, Math.floor((current / ach.goal) * 100));
        }
      },

      mounted() {
        // –ó–∞–≥—Ä—É–∑–∫–∞
        const saved = localStorage.getItem('listarisSave_v4');
        if (saved) {
          try {
            const data = JSON.parse(saved);
            Object.keys(data).forEach(key => {
              if (key in this.$data) this[key] = data[key];
            });
          } catch (e) {
            console.warn('Load failed', e);
          }
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        setInterval(() => {
          this.coins += this.getCoinsPerSec() / 10;
          if (this.showEnergy()) this.energy += this.getEnergyPerSec() / 10;
          if (this.showCrystals()) this.crystals += this.getCrystalsPerSec() / 10;

          if (Math.random() < 0.005) {
            localStorage.setItem('listarisSave_v4', JSON.stringify({
              coins: this.coins,
              chapter: this.chapter,
              prestigeLevel: this.prestigeLevel,
              souls: this.souls
            }));
          }

          this.achievements.forEach(a => {
            if (!a.unlocked && a.current() >= a.goal) {
              a.unlocked = true;
              this.addToast(`üèÜ ${a.name}`, 'achievement');
            }
          });
        }, 100);

        setInterval(() => {
          this.currentQuote = this.getRandomQuote();
        }, 20000);

        // PWA install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          this.deferredPrompt = e;
          document.getElementById('installPrompt').style.display = 'flex';
        });

        document.getElementById('installBtn')?.addEventListener('click', () => {
          if (this.deferredPrompt) {
            this.deferredPrompt.prompt();
            this.deferredPrompt.userChoice.then(() => {
              document.getElementById('installPrompt').style.display = 'none';
              this.deferredPrompt = null;
            });
          }
        });
      }
    }).mount('#app');
  </script>
</body>
</html>